<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Application Status - Borderly</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lexend:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
              display: ["Lexend", "sans-serif"],
            },
          },
        },
      }
    </script>
  </head>

  <body class="text-slate-800 bg-slate-50">
    <header class="bg-white shadow-sm sticky top-0 z-40">
      <nav
        class="container mx-auto px-6 py-4 flex justify-between items-center"
      >
        <h1 class="text-3xl font-bold text-slate-900">
          <a href="/">Borderly</a>
        </h1>
        <button
          id="logout-button"
          class="hidden bg-red-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-red-700 transition-colors"
        >
          Logout
        </button>
      </nav>
    </header>

    <main class="container mx-auto px-6 py-12">
      <section class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-lg">
        <h2 class="text-3xl font-bold text-slate-900 mb-6 text-center">
          Application Status
        </h2>
        <div id="status-container" class="space-y-4">
          <p class="text-slate-500 text-center">Loading status...</p>
        </div>
      </section>
    </main>

    <script type="module">
      import supabase from "./src/supabase-client.js"
      import { redirectTo } from "./src/ui.js"

      const statusContainer = document.getElementById("status-container")
      const logoutButton = document.getElementById("logout-button")

      async function fetchStatus() {
        const { data: { user } } = await supabase.auth.getUser()

        if (!user) {
          redirectTo("/")
          return
        }

        logoutButton.classList.remove("hidden")
        logoutButton.addEventListener("click", async () => {
          await supabase.auth.signOut()
          redirectTo("/")
        })

        const { data, error } = await supabase
          .from("applications")
          .select("status, created_at")
          .eq("user_id", user.id)
          .order("created_at", { ascending: false })
          .limit(1)

        if (error) {
          console.error("Error fetching status:", error)
          statusContainer.innerHTML = `<p class="text-red-500 text-center">Error fetching status.</p>`
          return
        }

        if (data && data.length > 0) {
          const application = data[0]
          const applicationDate = new Date(
            application.created_at
          ).toLocaleDateString()
          statusContainer.innerHTML = `
            <div class="p-4 bg-slate-100 rounded-md">
              <p class="font-semibold">Status: <span class="font-normal text-slate-700">${application.status}</span></p>
              <p class="font-semibold">Application Date: <span class="font-normal text-slate-700">${applicationDate}</span></p>
            </div>
          `
        } else {
          statusContainer.innerHTML = `<p class="text-slate-500 text-center">No application found.</p>`
        }
      }

      fetchStatus()
    </script>
  </body>
</html>
